let gameInterval,isPlaying,isKeyDown,lastX,lastY,isSameColumn,isSameRow,leftButton,rightButton,upButton,downButton,leftDown,rightDown,upDown,downDown,isTouch,KEY_LEFT=37,KEY_RIGHT=39,KEY_UP=38,KEY_DOWN=40,score=0,SCREEN_WIDTH=835,SCREEN_HEIGHT=469,CELL_SIZE=32,GRID_WIDTH=SCREEN_WIDTH/CELL_SIZE,GRID_HEIGHT=SCREEN_HEIGHT/CELL_SIZE,t=0,dt=10,currentTime=(new Date).getTime(),accumulator=0,canvas=document.createElement("canvas"),context=canvas.getContext("2d"),assetImages={};const playerImage=assetImages.player=new Image;assetImages.player.src="../assets/player.png";const ghostImage=assetImages.ghost=new Image;assetImages.ghost.src="../assets/ghost.png";const levelImage=assetImages.level=new Image;function init(){puffcontainer=document.getElementById("PuffPac"),container=document.createElement("div"),container.id="container",container.style.width=SCREEN_WIDTH+"px",container.style.height=SCREEN_HEIGHT+"px",puffcontainer.appendChild(container),container.appendChild(canvas),canvas.width=SCREEN_WIDTH,canvas.height=SCREEN_HEIGHT,document.addEventListener("keydown",onKeyPress,!1),document.addEventListener("keyup",onKeyPress,!1),container.addEventListener("click",onClicked,!1),level=new Level(levelImage,context),charcontainer=document.createElement("div"),charcontainer.className="charcontainer",charcontainer.style.width=SCREEN_WIDTH+"px",charcontainer.style.height=SCREEN_HEIGHT+"px",container.appendChild(charcontainer),player=new Player(CELL_SIZE,CELL_SIZE,playerImage),charcontainer.appendChild(player.domElement),ghost=new Ghost(11*CELL_SIZE,5*CELL_SIZE,ghostImage),charcontainer.appendChild(ghost.domElement),infobg=document.createElement("div"),infobg.id="infobg",infobg.className="info",infobg.style.width=SCREEN_WIDTH+"px",infobg.style.height=SCREEN_HEIGHT+"px",container.appendChild(infobg),info=document.createElement("div"),info.id="info",info.className="info",info.style.width="100%",container.appendChild(info),scoreContainer=document.createElement("div"),scoreContainer.id="score",scoreContainer.style.width=SCREEN_WIDTH+"px",puffcontainer.appendChild(scoreContainer),player.init(),ghost.init(),Modernizr.touch&&(isTouch=!0,makeControls()),showInfo("<a class='btn'>"+(isTouch?"TOUCH":"CLICK")+" TO START</a>")}function run(){var t=(new Date).getTime(),e=t-currentTime;for(currentTime=t,e>25&&(e=25),accumulator+=e;accumulator>=dt;)accumulator-=dt,update();render()}function update(){if(player.update(),ghost.update(),player.xp%CELL_SIZE==0&&player.yp%CELL_SIZE==0){var t=player.row=player.xp/CELL_SIZE,e=player.column=player.yp/CELL_SIZE;upDown&&player.dirY>-1&&0!=level.cellData[t][e-1]?player.moveUp():downDown&&player.dirY<1&&0!=level.cellData[t][e+1]?player.moveDown():leftDown&&player.dirX>-1&&0!=level.cellData[t-1][e]?player.moveLeft():rightDown&&player.dirX<1&&0!=level.cellData[t+1][e]?player.moveRight():1==player.dirX&&0==level.cellData[t+1][e]?player.stopMovement():-1==player.dirX&&0==level.cellData[t-1][e]?player.stopMovement():1==player.dirY&&0==level.cellData[t][e+1]?player.stopMovement():-1==player.dirY&&0==level.cellData[t][e-1]&&player.stopMovement(),1==level.cellData[t][e]&&(level.pips[t][e].munch(),level.cellData[t][e]=2,++score,document.getElementById("score").innerHTML="SCORE: <span>"+score+"<span>",score==level.totalPips&&onGameOver(!0)),isSameRow=player.row==ghost.row,isSameColumn=player.column==ghost.column}else upDown&&-1!=player.dirY&&0==player.dirX?player.moveUp():downDown&&1!=player.dirY&&0==player.dirX?player.moveDown():leftDown&&-1!=player.dirX&&0==player.dirY?player.moveLeft():rightDown&&1!=player.dirX&&0==player.dirY&&player.moveRight();if(ghost.xp%CELL_SIZE==0&&ghost.yp%CELL_SIZE==0&&(updateGhost(),isSameRow=player.row==ghost.row,isSameColumn=player.column==ghost.column),isSameRow||isSameColumn){var i=Math.abs(player.xp-ghost.xp),n=Math.abs(player.yp-ghost.yp);Math.sqrt(i*i+n*n)<CELL_SIZE&&onGameOver(!1)}}function render(){player.render(),ghost.render()}function updateGhost(){var t=player.row,e=player.column,i=t!=lastX||e!=lastY;lastX=t,lastY=e;var n=ghost.row,s=ghost.column,o=ghost.row=ghost.xp/CELL_SIZE,a=ghost.column=ghost.yp/CELL_SIZE;if(!ghost.chasing&&(0!=ghost.dirX||0!=ghost.dirY)){var r=!1;if(ghost.dirY<=-1&&0!=level.cellData[o][a-1]?r=!0:ghost.dirY>=1&&0!=level.cellData[o][a+1]?r=!0:ghost.dirX<=-1&&0!=level.cellData[o-1][a]?r=!0:ghost.dirX>=1&&0!=level.cellData[o+1][a]&&(r=!0),r)return}var h=[];if(0!=level.cellData[o+1][a]&&h.push([o+1,a,1,0]),0!=level.cellData[o-1][a]&&h.push([o-1,a,-1,0]),0!=level.cellData[o][a+1]&&h.push([o,a+1,0,1]),0!=level.cellData[o][a-1]&&h.push([o,a-1,0,-1]),1==h.length)ghost.dirX=h[0][2],ghost.dirY=h[0][3];else if(ghost.chasing){for(var l=1/0,d=h.length;--d>-1;){var c=Math.abs(t-h[d][0]),p=Math.abs(e-h[d][1]),m=Math.sqrt(c*c+p*p);m<l&&(h[d][0]!=n&&h[d][1]!=s||i)&&(l=m,u=h[d])}u&&(ghost.dirX=u[2],ghost.dirY=u[3])}else{var u=h[Math.floor(Math.random()*h.length)];ghost.dirX=u[2],ghost.dirY=u[3]}}function onGameOver(t){stopGame(),showInfo(t?"<h1>YOU WIN!</h1><p>Here's 1000 Puff Points<p><a class='btn'>"+(isTouch?"TOUCH":"CLICK")+" TO PLAY AGAIN</a></p>":"<h1>NO SNACKS FOR YOU!</h1><p><a class='btn'>"+(isTouch?"TOUCH":"CLICK")+" TO RESTART<span></p>"),container.addEventListener("click",onClicked,!1),isTouch&&container.addEventListener("touchstart",onClicked,!1),container.style.cursor="pointer"}function resetGame(){score=0,level.reset(),player.reset(),ghost.reset()}function showInfo(t){t&&(document.getElementById("info").innerHTML=t,info.style.top=.5*(SCREEN_HEIGHT-info.offsetHeight)+"px"),info.style.opacity=1,infobg.style.opacity=.75}function makeControls(){document.addEventListener("touchmove",function(t){t.preventDefault()},!1),document.addEventListener("touchstart",function(t){t.preventDefault()},!1);var t,e=120;buttons=document.createElement("div"),buttons.id="container",buttons.style.width=SCREEN_WIDTH+"px",buttons.style.height=SCREEN_HEIGHT+"px",puffcontainer.appendChild(buttons),t=new KeyButton(.5*SCREEN_WIDTH-60-e,70),(leftButton=t.domElement).addEventListener("touchstart",onKeyPress,!1),leftButton.addEventListener("touchend",onKeyPress,!1),buttons.appendChild(leftButton),t=new KeyButton(.5*SCREEN_WIDTH+60,70),(rightButton=t.domElement).addEventListener("touchstart",onKeyPress,!1),rightButton.addEventListener("touchend",onKeyPress,!1),buttons.appendChild(rightButton),t=new KeyButton(.5*(SCREEN_WIDTH-e),10),(upButton=t.domElement).addEventListener("touchstart",onKeyPress,!1),upButton.addEventListener("touchend",onKeyPress,!1),buttons.appendChild(upButton),t=new KeyButton(.5*(SCREEN_WIDTH-e),130),(downButton=t.domElement).addEventListener("touchstart",onKeyPress,!1),downButton.addEventListener("touchend",onKeyPress,!1),buttons.appendChild(downButton),container.addEventListener("touchstart",onClicked,!1)}function onClicked(t){container.removeEventListener("click",onClicked,!1),isTouch&&container.removeEventListener("touchstart",onClicked,!1),container.style.cursor="default",startGame(),info.style.opacity=0,infobg.style.opacity=0}function onKeyPress(t){switch(isPlaying||isKeyDown||onClicked(),isKeyDown=isTouch?"touchstart"==t.type:"keydown"==t.type,isTouch?t.target:t.keyCode){case KEY_LEFT:case leftButton:leftDown=isKeyDown;break;case KEY_RIGHT:case rightButton:rightDown=isKeyDown;break;case KEY_UP:case upButton:upDown=isKeyDown;break;case KEY_DOWN:case downButton:downDown=isKeyDown}}function startGame(){isPlaying||(isPlaying=!0,document.getElementById("score").innerHTML="SCORE: "+score,resetGame(),gameInterval=setInterval(run,1))}function stopGame(){isPlaying=!1,clearInterval(gameInterval)}function Animation(t,e,i,n){t=this.img=t,this.domElement=n;this.playing=!0,this.looping=!0,this.width=e,this.height=i,this.x=0,this.y=0,this.rotation=0,this.offsetX=0,this.offsetY=0,this.spriteSheetWidth=this.img.width,this.numFrames=Math.floor(this.spriteSheetWidth/this.width),this.currentFrame=0,this.domElement||(this.domElement=document.createElement("div"),this.domElement.className="animation",this.domElement.style.background="url("+t.src+")",this.domElement.style.width=this.width+"px",this.domElement.style.height=this.height+"px"),this.update=function(){if(this.playing){var t=this.currentFrame+1;t>=this.numFrames?this.looping?this.gotoAndStop(0):(this.playing=!1,this.gotoAndStop(this.numFrames-1)):this.gotoAndStop(t)}},this.render=function(){var e=this.domElement,i=this.currentFrame*this.width;e.style.background="url("+t.src+")",e.style.width=this.width+"px",e.style.height=this.height+"px",e.style.backgroundPosition=i+"px 0 ";var n=Math.round(this.x+this.offsetX),s=Math.round(this.y+this.offsetY);styleStr="translate("+n+"px, "+s+"px)",e.style.webkitTransform=styleStr,e.style.MozTransform=styleStr,e.style.OTransform=styleStr,e.style.transform=styleStr,styleStr="rotate("+this.rotation+"deg)",e.style.webkitTransform+=styleStr,e.style.MozTransform+=styleStr,e.style.OTransform+=styleStr,e.style.transform+=styleStr},this.play=function(){this.playing=!0},this.gotoAndStop=function(t){this.currentFrame=t},this.stop=function(){this.playing=!1}}function Ghost(t,e,i){this.row=t/CELL_SIZE,this.column=e/CELL_SIZE,this.speed=1;this.xp=this.startX=t,this.yp=this.startY=e,this.dirX=0,this.dirY=0;this.chaseTime=7,this.idleTime=3,this.chasing=!1;var n=this;this.interval=setInterval(function(){n.changeChase()},1e3*this.idleTime),this.width=32,this.height=32;var s=this.animation=new Animation(i,32,32,o);s.offsetY=0,s.offsetX=0,s.looping=!0,s.play();var o=this.domElement=this.animation.domElement;this.moveRight=function(){this.dirX=this.speed,this.dirY=0,this.animation.rotation=0},this.moveLeft=function(){this.dirX=-this.speed,this.dirY=0,this.animation.rotation=180},this.moveUp=function(){this.dirX=0,this.dirY=-this.speed,this.animation.rotation=270},this.moveDown=function(){this.dirX=0,this.dirY=this.speed,this.animation.rotation=90},this.stopMovement=function(){this.dirX=this.dirY=0},this.update=function(){this.xp+=this.dirX,this.yp+=this.dirY,this.animation.x=this.xp,this.animation.y=this.yp,this.animation.update()},this.render=function(){this.animation.render()},this.getLeft=function(){return this.xp},this.getRight=function(){return this.xp+this.width},this.getTop=function(){return this.yp},this.getBottom=function(){return this.yp+this.height},this.changeChase=function(){clearInterval(this.interval),this.chasing=!this.chasing;var t=this,e=this.chasing?this.chaseTime:this.idleTime;this.interval=setInterval(function(){t.changeChase()},1e3*e)},this.reset=function(){this.xp=this.startX,this.yp=this.startY},this.init=function(){this.update(),this.render()}}function KeyButton(t,e){var i=this.domElement=document.createElement("div");i.className="keybutton",i.style.left=t+"px",i.style.top=e+"px"}function Level(t,e){var i=e;this.totalPips=0,i.fillStyle="#00FF00",i.fillRect(0,0,SCREEN_WIDTH,SCREEN_HEIGHT),i.drawImage(t,0,0);for(var n,s,o=0,a=CELL_SIZE/2,r=this.cellData=[],h=this.pips=[];o<GRID_WIDTH;++o){for(r[o]=[],h[o]=[],s=CELL_SIZE/2,n=0;n<GRID_HEIGHT;++n){if(r[o][n]=255==i.getImageData(a,s,1,1).data[1]?1:0,1==r[o][n]){var l=new Pip(a,s,7);container.appendChild(l.domElement),h[o][n]=l,++this.totalPips}s+=CELL_SIZE}a+=CELL_SIZE}i.fillStyle="#fff",i.fillRect(0,0,SCREEN_WIDTH,SCREEN_HEIGHT),i.drawImage(t,0,0),this.reset=function(){for(var t=h.length;--t>-1;)for(var e=h[t].length;--e>-1;)null!=h[t][e]&&h[t][e].munched&&(h[t][e].reset(),r[t][e]=1)}}function Pip(t,e,i){this.width=this.height=i,this.munched=!1,this.domElement=document.createElement("div"),this.domElement.className="pip",this.domElement.style.width=i+"px",this.domElement.style.height=i+"px",this.domElement.style.borderRadius=i+"px",this.domElement.style.left=Math.round(t-i/2)+"px",this.domElement.style.top=Math.round(e-i/2)+"px",this.munch=function(){this.munched=!0,this.domElement.style.opacity=0},this.reset=function(){this.munched=!1,this.domElement.style.opacity=1}}function Player(t,e,i){this.row=t/CELL_SIZE,this.column=e/CELL_SIZE,this.speed=1;this.xp=this.startX=t,this.yp=this.startY=e,this.dirX=0,this.dirY=0;var n=this.animation=new Animation(i,CELL_SIZE,CELL_SIZE,s);n.offsetY=0,n.offsetX=0,n.looping=!0,n.stop();var s=this.domElement=this.animation.domElement;this.moveRight=function(){this.dirX=this.speed,this.dirY=0,this.animation.rotation=0,this.animation.playing||this.animation.play()},this.moveLeft=function(){this.dirX=-this.speed,this.dirY=0,this.animation.rotation=180,this.animation.playing||this.animation.play()},this.moveUp=function(){this.dirX=0,this.dirY=-this.speed,this.animation.rotation=90,this.animation.playing||this.animation.play()},this.moveDown=function(){this.dirX=0,this.dirY=this.speed,this.animation.rotation=270,this.animation.playing||this.animation.play()},this.stopMovement=function(){this.dirX=this.dirY=0,this.animation.stop()},this.update=function(){this.xp+=this.dirX,this.yp+=this.dirY,this.animation.x=this.xp,this.animation.y=this.yp,this.animation.update()},this.render=function(){this.animation.render()},this.reset=function(){this.xp=this.startX,this.yp=this.startY,this.stopMovement(),this.animation.rotation=0,this.animation.gotoAndStop(1)},this.init=function(){this.update(),this.render()}}assetImages.level.src="../assets/puffpac.png";